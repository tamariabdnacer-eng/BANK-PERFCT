<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø¨Ù†Ùƒ Ø¨ÙŠØ±ÙÙƒØª</title>

<link rel="icon" type="image/png" href="favicon.png">

<style>
body {background: linear-gradient(135deg,#0f2027,#00545f,#000a61fd);color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;transition:background 0.5s;}
.box {background: rgba(255,255,255,0.05);backdrop-filter:blur(10px);width:400px;padding:25px;border-radius:20px;box-shadow:0 10px 35px rgba(0,0,0,0.6);transition:transform 0.3s, box-shadow 0.3s;}
.box:hover {transform:translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,0.7);}
h2,h3 {text-align:center;font-weight:600;}
.section {margin-bottom:25px;}
input,button {width:100%;padding:10px 12px;margin-top:8px;border:none;border-radius:8px;font-size:15px;outline:none;transition:all 0.3s;}
input {background: rgba(255,255,255,0.1);color:#fff;}
input::placeholder {color:#ddd;}
input:focus {background: rgba(255,255,255,0.2); box-shadow:0 0 5px #0984e3;}
button {background:linear-gradient(90deg,#009c94,#0004ff);color:#fff;font-weight:bold;cursor:pointer;}
button:hover {background:linear-gradient(90deg,#04fff2bd,#00eeff);transform:scale(1.05);}
.danger {background:linear-gradient(90deg,#e74c3c,#d63031);}
.danger:hover {background:linear-gradient(90deg,#ff7675,#e17055);}
#msg,#msgMain,#msgForgot,#msgRegister,#msgQR {text-align:center;margin-top:6px;font-weight:bold;}
a {text-decoration:none;color:#00ff22;cursor:pointer;}
video {width:100%;border-radius:12px;margin-top:10px;}
.history {background: rgba(0,0,0,0.3);padding:12px;max-height:160px;overflow-y:auto;font-size:14px;border-radius:8px;box-shadow: inset 0 0 5px rgba(255,255,255,0.1);}
.history::-webkit-scrollbar {width:6px;}
.history::-webkit-scrollbar-thumb {background:#0004ff;border-radius:3px;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body>

<!-- Login -->
<div id="loginDiv" class="box">
  <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p style="text-align:center; margin-top:10px;"><a onclick="showForgot()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a></p>
  <hr style="margin:15px 0; border-color: rgba(255,255,255,0.2)">
  <h3>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
  <button onclick="showRegister()">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
  <p id="msg"></p>
</div>

<div id="registerDiv" class="box" style="display:none">
  <h3>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
  <input id="regUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="regPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <p id="msgRegister"></p>
  <button onclick="backToLogin()" style="margin-top:10px; background:#e67e22;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="forgotDiv" class="box" style="display:none">
  <h3>ğŸ”‘ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
  <input id="forgotUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="forgotPin" type="number" placeholder="Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† PIN">
  <input id="newPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
  <button onclick="resetPassword()">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
  <p id="msgForgot"></p>
  <button onclick="backToLogin()" style="margin-top:10px; background:#e67e22;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Main -->
<div id="mainDiv" class="box" style="display:none">
  <div style="text-align:center; margin-bottom:15px;">
  <img src="LO.png" alt="Ø§Ù„Ø¨Ù†Ùƒ Ø¨ÙŠØ±ÙÙƒØª" style="width:140px;">
</div>
  <div class="section">
    <h3>BANK PERFECT</h3>
    <div class="balance-card">
      <div class="chip"></div>
      <div class="balance-box">
  <span class="balance-title">Ø±ØµÙŠØ¯Ùƒ </span>
  <div class="balance-row">
    <span class="currency">$</span>
    <span class="balance-amount" id="balance">0</span>
  </div>
  <span class="balance-note"> Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… </span>
</div>

      <div class="user-name" id="userNameDisplay">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
    </div>
  </div>

  <div class="section section-card">
    <h3>ğŸ”‘ Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
    <input id="codeInput" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù†">
    <button onclick="recharge()">Ø´Ø­Ù†</button>
    <p id="msgMain"></p>
  </div>

  <div class="section section-card">
    <h3>ğŸ’³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
    <div class="card-display">
      <div class="chip"></div>
      <h3 id="cardNumber">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3>
      <div class="amount" id="cvv">---</div>
      <div class="user-name">Card Holder: <span id="userNameCard">---</span></div>
    </div>
    <button onclick="createCard()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©</button>
  </div>

  <div class="section section-card">
    <h3>ğŸ” ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯</h3>
    <input id="toUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="transferAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    <button onclick="transferMoney()">ØªØ­ÙˆÙŠÙ„</button>
  </div>

  <!-- Ø¯ÙØ¹ QR -->
  <div class="section section-card">
    <h3>ğŸ“± Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</h3>
    <button onclick="startQRPay()">Ù…Ø³Ø­ QR Ù„Ù„Ø¯ÙØ¹</button>
    <video id="video" style="display:none"></video>
    <p id="msgQR"></p>
  </div>

  <div class="section">
    <h3>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <div id="history" class="history"></div>
  </div>

  <div class="section">
    <button class="danger" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAM7gLKuLRfhFdWyakFS1jU4c8xU1fg-FU",
  authDomain: "family-bank-966ae.firebaseapp.com",
  databaseURL: "https://family-bank-966ae-default-rtdb.firebaseio.com",
  projectId: "family-bank-966ae",
  storageBucket: "family-bank-966ae.firebasestorage.app",
  messagingSenderId: "479496038450",
  appId: "1:479496038450:web:49ee61a36a621abd3c742b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let users = {};
let rechargeCodes = { "VIPZD0":0};

function saveUsers(){db.ref('users').set(users);}
function loadUsers(callback){db.ref('users').once('value').then(snap=>{users=snap.val()||{};callback();});}

// Login
function login(){
  let u=document.getElementById('username').value.trim();
  let p=document.getElementById('password').value.trim();
  const msg=document.getElementById('msg');
  loadUsers(()=>{
    if(!users[u]||users[u].password!==p){msg.innerText="âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©";return;}
    currentUser=u;
    document.getElementById('loginDiv').style.display="none";
    document.getElementById('mainDiv').style.display="block";
    initUserUI();
  });
}

// Register
function showRegister(){document.getElementById('loginDiv').style.display='none';document.getElementById('registerDiv').style.display='block';}
function register(){
  let u=document.getElementById('regUsername').value.trim();
  let p=document.getElementById('regPassword').value.trim();
  const msg=document.getElementById('msgRegister');
  if(!u||!p){msg.innerText="âŒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"; return;}
  loadUsers(()=>{
    if(users[u]){msg.innerText="âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯"; return;}
    let pin = Math.floor(1000 + Math.random() * 9000);
    users[u]={password:p,balance:0,history:[],cardNumber:null,cvv:null,pin:pin};
    saveUsers();
    msg.innerText=`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: ${pin}`;
  });
}
function backToLogin(){document.getElementById('registerDiv').style.display='none';document.getElementById('forgotDiv').style.display='none';document.getElementById('loginDiv').style.display='block';}

// Reset Password
function showForgot(){document.getElementById('loginDiv').style.display='none';document.getElementById('forgotDiv').style.display='block';}
function resetPassword(){
  let u=document.getElementById('forgotUsername').value.trim();
  let pin=document.getElementById('forgotPin').value.trim();
  let newPass=document.getElementById('newPassword').value.trim();
  let msg=document.getElementById('msgForgot');
  if(!u||!pin||!newPass){msg.innerText="âŒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"; return;}
  loadUsers(()=>{
    if(!users[u]){msg.innerText="âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; return;}
    if(users[u].pin!=pin){msg.innerText="âŒ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­"; return;}
    users[u].password=newPass;
    saveUsers();
    msg.innerText="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­";
  });
}

// Main
function initUserUI(){
  let user=users[currentUser];
  user.balance=user.balance||0;
  user.history=user.history||[];
  user.cardNumber=user.cardNumber||null;
  user.cvv=user.cvv||null;
  document.getElementById("balance").innerText=user.balance;
  document.getElementById("userNameDisplay").innerText=currentUser;
  document.getElementById("cardNumber").innerText=user.cardNumber||"ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
  document.getElementById("cvv").innerText=user.cvv||"---";
  document.getElementById("userNameCard").innerText=currentUser;
  showHistory();
}

function recharge(){
  let code=document.getElementById('codeInput').value.trim();
  let msg=document.getElementById('msgMain');
  let user=users[currentUser];
  if(!(code in rechargeCodes)){msg.innerText="âŒ ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù…";return;}
  let amount=rechargeCodes[code];
  user.balance+=amount;
  user.history.push(`ğŸ’° Ø´Ø­Ù† +${amount}$ (ÙƒÙˆØ¯ ${code})`);
  delete rechargeCodes[code];
  document.getElementById("balance").innerText=user.balance;
  msg.innerText=`âœ… ØªÙ… Ø´Ø­Ù† ${amount}$`;
  saveUsers();
  showHistory();
}

function createCard(){
  let user=users[currentUser];
  if(user.cardNumber){alert("âŒ Ù„Ø¯ÙŠÙƒ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø§Ù„ÙØ¹Ù„");return;}
  user.cardNumber="4000-"+Math.floor(1000+Math.random()*9000)+"-"+Math.floor(1000+Math.random()*9000)+"-"+Math.floor(1000+Math.random()*9000);
  user.cvv=Math.floor(100+Math.random()*900);
  user.history.push("ğŸ’³ Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©");
  document.getElementById("cardNumber").innerText=user.cardNumber;
  document.getElementById("cvv").innerText=user.cvv;
  document.getElementById("userNameCard").innerText=currentUser;
  saveUsers();
  showHistory();
}

function transferMoney(){
  let toUser=document.getElementById('toUser').value.trim();
  let amount=parseInt(document.getElementById('transferAmount').value,10);
  let user=users[currentUser];
  if(!users[toUser]) return alert("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  if(toUser===currentUser) return alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ");
  if(!amount||amount<=0) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­");
  if(amount>10000) return alert("âŒ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§");
  if(user.balance<amount) return alert("âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");
  user.balance-=amount;
  users[toUser].balance+=amount;
  user.history.push(`ğŸ” ØªØ­ÙˆÙŠÙ„ -${amount}$ Ø¥Ù„Ù‰ ${toUser}`);
  users[toUser].history=users[toUser].history||[];
  users[toUser].history.push(`ğŸ” ØªØ­ÙˆÙŠÙ„ +${amount}$ Ù…Ù† ${currentUser}`);
  document.getElementById("balance").innerText=user.balance;
  alert("âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„");
  saveUsers();
  showHistory();
}

function showHistory(){
  let box=document.getElementById("history");
  if(!box) return;
  let user=users[currentUser];
  box.innerHTML="";
  user.history.forEach(h=>{
    let p=document.createElement("p");
    p.innerText=h;
    box.appendChild(p);
  });
}

// Logout
function logout(){currentUser=null; location.reload();}

// ---------------- QR Pay ----------------
let video = document.getElementById('video');
let scanning = false;
function startQRPay(){
  if(scanning) return;
  scanning = true;
  video.style.display='block';
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{video.srcObject=stream; video.setAttribute("playsinline",true); video.play(); tick();})
    .catch(err=>{document.getElementById('msgQR').innerText="âŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§"; scanning=false;});
}

function tick(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    let canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    let ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    let imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    let code = jsQR(imageData.data, canvas.width, canvas.height);
    if(code){
      processQRPayment(code.data);
      stopVideo();
      return;
    }
  }
  if(scanning) requestAnimationFrame(tick);
}

function stopVideo(){
  scanning=false;
  video.srcObject.getTracks().forEach(track=>track.stop());
  video.style.display='none';
}

function processQRPayment(data){
  let msg = document.getElementById('msgQR');
  let payment;
  try { payment = JSON.parse(data); } catch(e){msg.innerText="âŒ QR ØºÙŠØ± ØµØ§Ù„Ø­"; return;}

  let fromUser = users[currentUser];
  let toUser = payment.storeId;

  if(!users[toUser]){
    msg.innerText = "âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }
  if(fromUser.balance < payment.amount){
    msg.innerText = "âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ"; 
    return;
  }

  fromUser.balance -= payment.amount;
  fromUser.history.push(`ğŸ“± Ø¯ÙØ¹ ${payment.amount}$ Ø¥Ù„Ù‰ ${toUser}`);

  users[toUser].balance += payment.amount;
  users[toUser].history = users[toUser].history || [];
  users[toUser].history.push(`ğŸ“± Ø§Ø³ØªÙ„Ø§Ù… ${payment.amount}$ Ù…Ù† ${currentUser}`);

  document.getElementById("balance").innerText = fromUser.balance;
  saveUsers();
  showHistory();
  msg.innerText = `âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${toUser}`;
}
</script>
</body>

</html>


